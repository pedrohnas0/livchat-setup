# Plan 03: Integration Layer - Portainer, Cloudflare & App Registry

## üìã Contexto

Conforme **CLAUDE.md Phase 3: Integrations**, precisamos implementar:
- Portainer API client (pr√≥prio, sem SDKs de terceiros)
- Cloudflare API integration (SDK oficial)
- App Registry com defini√ß√µes YAML
- Post-deploy configurations

## üéØ Objetivo

Criar a camada de integra√ß√£o para gerenciar aplica√ß√µes via Portainer e DNS via Cloudflare, com sistema de App Registry para definir e deployar apps de forma padronizada.

## üîê Fluxo de Seguran√ßa e Inicializa√ß√£o

### Gest√£o de Credenciais com Vault
- **Senhas Seguras**: 64 caracteres com letras mai√∫sculas, min√∫sculas, n√∫meros e especiais
- **Armazenamento**: Todas as credenciais no Ansible Vault
- **Email do Admin**: Configur√°vel via `livchat-setup configure --admin-email seu@email.com`
- **Sem Hardcode**: Nenhum dado pessoal no c√≥digo

### Inicializa√ß√£o Autom√°tica do Portainer
A API do Portainer **suporta cria√ß√£o autom√°tica do primeiro admin** via `/api/users/admin/init`:
```
POST /api/users/admin/init
{
  "Username": "admin_email@example.com",
  "Password": "64_character_secure_password"
}
```
**Fluxo Implementado:**
1. Deploy do Portainer via Ansible
2. Aguarda Portainer ficar ready (health check)
3. Gera credenciais seguras (ou usa do Vault se existir)
4. Cria admin automaticamente via API
5. Salva credenciais no Vault
6. Mostra URL de acesso ao usu√°rio
7. **Sem intera√ß√£o humana necess√°ria!**

## üìä Escopo Definitivo

### Componente 1: Portainer Client (Pr√≥prio)

```python
# src/integrations/portainer.py
class PortainerClient:
    """Cliente REST pr√≥prio para Portainer API v2.x"""

    def __init__(self, url: str, username: str, password: str):
        """Inicializa cliente com autentica√ß√£o"""

    async def authenticate(self) -> str:
        """POST /api/auth - Retorna JWT token"""

    async def create_stack(self, name: str, compose: str, env: Dict) -> Dict:
        """POST /api/stacks - Deploy de stack"""

    async def get_stack(self, stack_id: int) -> Dict:
        """GET /api/stacks/{id} - Info da stack"""

    async def delete_stack(self, stack_id: int) -> bool:
        """DELETE /api/stacks/{id} - Remove stack"""

    async def list_endpoints(self) -> List[Dict]:
        """GET /api/endpoints - Lista environments"""
```

**Por que cliente pr√≥prio?** Controle total sobre a implementa√ß√£o, sem depend√™ncias externas, melhor para manuten√ß√£o.

### Componente 2: Cloudflare Client (SDK Oficial com Global API Key)

```python
# src/integrations/cloudflare.py
class CloudflareClient:
    """Wrapper do SDK oficial cloudflare usando Global API Key + Email"""

    def __init__(self, email: str, global_api_key: str):
        """Inicializa com email + Global API Key
        self.client = Cloudflare(api_email=email, api_key=global_api_key)
        """

    async def list_zones(self) -> List[Zone]:
        """Lista todas as zonas DNS dispon√≠veis (ex: livchat.ai)"""

    async def get_zone(self, zone_name: str) -> Zone:
        """Obt√©m zona espec√≠fica por nome"""

    async def create_dns_record(self, zone_id: str, type: str, name: str,
                              content: str, proxied: bool = False,
                              comment: str = None) -> str:
        """Cria registro DNS gen√©rico"""

    async def setup_server_dns(self, server: Dict, zone_name: str, subdomain: str = None):
        """Configura DNS principal do servidor (registro A do Portainer)
        - Cria: ptn.{subdomain}.{zone} ou ptn.{zone} -> IP
        - Comment: "portainer"
        - Proxied: false
        """

    async def add_app_dns(self, app_prefix: str, zone_name: str, subdomain: str = None,
                         comment: str = None):
        """Adiciona CNAME para aplica√ß√£o
        - Cria: {app_prefix}.{subdomain}.{zone} -> ptn.{subdomain}.{zone}
        - Comment: nome da app
        - Proxied: false
        """
```

#### Padr√£o de DNS Implementado

**Template Padr√£o:**
```dns
;; A Records
ptn.seu-dominio.com.        1 IN  A 0.0.0.0 ; portainer cf_tags=cf-proxied:false

;; CNAME Records
log.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; dozzle cf_tags=cf-proxied:false
gfn.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; grafana cf_tags=cf-proxied:false
pga.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; pgadmin cf_tags=cf-proxied:false
rmq.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; rabbit cf_tags=cf-proxied:false
mno.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; minio cf_tags=cf-proxied:false
s3.seu-dominio.com.         1 IN  CNAME ptn.seu-dominio.com. ; backend minio cf_tags=cf-proxied:false
dir.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; directus cf_tags=cf-proxied:false
chat.seu-dominio.com.       1 IN  CNAME ptn.seu-dominio.com. ; chatwoot cf_tags=cf-proxied:false
evo.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; evolution cf_tags=cf-proxied:false
edt.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; n8n cf_tags=cf-proxied:false
whk.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; n8n webhook cf_tags=cf-proxied:false
pdf.seu-dominio.com.        1 IN  CNAME ptn.seu-dominio.com. ; pdf cf_tags=cf-proxied:false
```

**Com Subdom√≠nio (lab, dev, ops, etc):**
```dns
;; A Records
ptn.lab.livchat.ai.         1 IN  A 168.119.89.45 ; portainer cf_tags=cf-proxied:false

;; CNAME Records
chat.lab.livchat.ai.        1 IN  CNAME ptn.lab.livchat.ai. ; chatwoot cf_tags=cf-proxied:false
edt.lab.livchat.ai.         1 IN  CNAME ptn.lab.livchat.ai. ; n8n cf_tags=cf-proxied:false
```

**Nomenclatura Padr√£o:**
- `ptn` - Portainer (SEMPRE registro A principal)
- `log` - Dozzle (logs)
- `gfn` - Grafana
- `pga` - pgAdmin
- `rmq` - RabbitMQ
- `mno` - MinIO
- `s3` - MinIO S3 backend
- `dir` - Directus
- `chat` - Chatwoot
- `evo` - Evolution API
- `edt` - N8N Editor
- `whk` - N8N Webhook
- `pdf` - PDF Service

**Regras:**
1. Proxy SEMPRE desativado (`cf-proxied:false`)
2. Coment√°rios simples com nome da app
3. Todos CNAMEs apontam para `ptn.{subdomain}.{zone}`
4. Mudan√ßa de IP = atualizar apenas registro A do `ptn`

### Componente 3: App Registry

```python
# src/app_registry.py
class AppRegistry:
    """Sistema de registro e defini√ß√£o de aplica√ß√µes"""

    def load_definitions(self, path: str = "apps/") -> None:
        """Carrega todas as defini√ß√µes YAML"""

    def get_app(self, name: str) -> AppDefinition:
        """Retorna defini√ß√£o de uma app"""

    def validate_app(self, app: AppDefinition) -> ValidationResult:
        """Valida schema e depend√™ncias"""

    def generate_compose(self, app: AppDefinition, config: Dict) -> str:
        """Gera docker-compose.yml para a app"""

    def resolve_dependencies(self, app_name: str) -> List[str]:
        """Resolve ordem de instala√ß√£o com depend√™ncias"""
```

### Componente 4: App Deployer

```python
# src/app_deployer.py
class AppDeployer:
    """Orquestra deploy de aplica√ß√µes"""

    def __init__(self, portainer: PortainerClient,
                 cloudflare: CloudflareClient,
                 registry: AppRegistry):
        """Injeta depend√™ncias"""

    async def deploy(self, server: Server, app_name: str, config: Dict) -> Result:
        """Deploy completo da aplica√ß√£o"""

    async def configure_dns(self, server: Server, app: str, domain: str) -> Result:
        """Configura DNS para a aplica√ß√£o"""

    async def verify_health(self, server: Server, app: str) -> HealthStatus:
        """Verifica sa√∫de da aplica√ß√£o"""

    async def rollback(self, server: Server, app: str) -> Result:
        """Rollback em caso de falha"""
```

### Componente 5: Defini√ß√µes YAML

```yaml
# apps/definitions/infrastructure/portainer.yaml
name: portainer
category: infrastructure
version: "2.19.4"
description: Container management platform

ports:
  - "9443:9443"  # HTTPS UI
  - "8000:8000"  # Edge agent

volumes:
  - portainer_data:/data

environment:
  - ADMIN_PASSWORD: "{{ vault.portainer_password }}"

deploy:
  mode: global
  placement:
    constraints:
      - node.role == manager

health_check:
  endpoint: https://localhost:9443
  interval: 30s
  retries: 3
```

## üß™ Estrat√©gia de Testes TDD

### Etapa 1: Portainer Client Tests
```python
# tests/unit/test_portainer_client.py

def test_authentication_success():
    """Testa autentica√ß√£o bem sucedida"""

def test_authentication_failure():
    """Testa falha de autentica√ß√£o"""

def test_create_stack():
    """Testa cria√ß√£o de stack com mock"""

def test_stack_not_found():
    """Testa erro 404 ao buscar stack"""

def test_retry_on_timeout():
    """Testa retry autom√°tico em timeout"""
```

### Etapa 2: Cloudflare Client Tests
```python
# tests/unit/test_cloudflare_client.py

def test_zone_listing():
    """Testa listagem de zonas DNS"""

def test_create_a_record():
    """Testa cria√ß√£o de registro A"""

def test_create_cname_record():
    """Testa cria√ß√£o de CNAME"""

def test_enable_proxy():
    """Testa ativa√ß√£o do proxy Cloudflare"""
```

### Etapa 3: App Registry Tests
```python
# tests/unit/test_app_registry.py

def test_load_yaml_definitions():
    """Testa carregamento de defini√ß√µes"""

def test_validate_app_schema():
    """Testa valida√ß√£o de schema YAML"""

def test_dependency_resolution():
    """Testa resolu√ß√£o de depend√™ncias"""

def test_circular_dependency_detection():
    """Testa detec√ß√£o de depend√™ncia circular"""
```

### Etapa 4: Integration Tests
```python
# tests/integration/test_portainer_integration.py

@pytest.mark.integration
async def test_portainer_real_deployment():
    """Deploy real no Portainer local"""

# tests/integration/test_cloudflare_integration.py

@pytest.mark.integration
async def test_dns_record_lifecycle():
    """Cria, atualiza e deleta registro DNS"""
```

### Etapa 5: E2E Tests
```python
# tests/e2e/test_complete_app_deployment.py

@pytest.mark.e2e
async def test_deploy_postgres_with_dns():
    """Deploy completo: Postgres + DNS + Health check"""
```

## üìÅ Estrutura de Arquivos

```
LivChatSetup/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ portainer.py       # Cliente REST pr√≥prio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cloudflare.py      # Wrapper do SDK oficial
‚îÇ   ‚îú‚îÄ‚îÄ app_registry.py        # Sistema de registro
‚îÇ   ‚îú‚îÄ‚îÄ app_deployer.py        # Orquestrador de deploy
‚îÇ   ‚îî‚îÄ‚îÄ orchestrator.py        # ATUALIZAR
‚îÇ
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ catalog.yaml           # √çndice de apps
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app-definition.json # JSON Schema para valida√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ definitions/
‚îÇ       ‚îú‚îÄ‚îÄ infrastructure/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ portainer.yaml
‚îÇ       ‚îú‚îÄ‚îÄ databases/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ postgres.yaml
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ redis.yaml
‚îÇ       ‚îî‚îÄ‚îÄ applications/
‚îÇ           ‚îú‚îÄ‚îÄ n8n.yaml
‚îÇ           ‚îî‚îÄ‚îÄ chatwoot.yaml
‚îÇ
‚îú‚îÄ‚îÄ ansible/
‚îÇ   ‚îî‚îÄ‚îÄ playbooks/
‚îÇ       ‚îî‚îÄ‚îÄ portainer-deploy.yml
‚îÇ
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ portainer-stack.j2
‚îÇ   ‚îî‚îÄ‚îÄ app-compose.j2
‚îÇ
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ unit/
    ‚îÇ   ‚îú‚îÄ‚îÄ test_portainer_client.py
    ‚îÇ   ‚îú‚îÄ‚îÄ test_cloudflare_client.py
    ‚îÇ   ‚îú‚îÄ‚îÄ test_app_registry.py
    ‚îÇ   ‚îî‚îÄ‚îÄ test_app_deployer.py
    ‚îú‚îÄ‚îÄ integration/
    ‚îÇ   ‚îú‚îÄ‚îÄ test_portainer_integration.py
    ‚îÇ   ‚îî‚îÄ‚îÄ test_cloudflare_integration.py
    ‚îî‚îÄ‚îÄ e2e/
        ‚îî‚îÄ‚îÄ test_complete_app_deployment.py
```

## ‚úÖ Checklist de Implementa√ß√£o

### Task 1: Portainer Deployment
- [ ] Criar playbook `portainer-deploy.yml`
- [ ] Template Jinja2 para stack
- [ ] Integrar no ServerSetup
- [ ] Test: Deploy em servidor real

### Task 2: Portainer Client
- [ ] TDD: Escrever testes unit√°rios
- [ ] Implementar autentica√ß√£o JWT
- [ ] Implementar CRUD de stacks
- [ ] Implementar gest√£o de endpoints
- [ ] Test: Mock responses

### Task 3: Cloudflare Client
- [ ] TDD: Escrever testes unit√°rios
- [ ] Wrapper do SDK oficial
- [ ] M√©todos para DNS records
- [ ] Proxy e SSL config
- [ ] Test: Com zona de teste

### Task 4: App Registry
- [ ] TDD: Escrever testes unit√°rios
- [ ] Schema JSON para valida√ß√£o
- [ ] Loader de defini√ß√µes YAML
- [ ] Dependency resolver
- [ ] Template engine
- [ ] Test: Valida√ß√£o de schemas

### Task 5: App Deployer
- [ ] TDD: Escrever testes unit√°rios
- [ ] Orquestra√ß√£o de deploy
- [ ] Configura√ß√£o DNS autom√°tica
- [ ] Health checks
- [ ] Rollback mechanism
- [ ] Test: Deploy mock

### Task 6: App Definitions
- [ ] Definir schema padr√£o
- [ ] Criar catalog.yaml
- [ ] Portainer definition
- [ ] Postgres definition
- [ ] Redis definition
- [ ] Test: Validar YAMLs

### Task 7: CLI Integration
- [ ] Comando `deploy-app`
- [ ] Comando `list-apps`
- [ ] Comando `configure-dns`
- [ ] Comando `app-status`
- [ ] Test: CLI commands

### Task 8: Integration Tests
- [ ] Portainer local test
- [ ] Cloudflare sandbox test
- [ ] App deployment test
- [ ] DNS configuration test

### Task 9: E2E Test
- [ ] Setup servidor completo
- [ ] Deploy Portainer
- [ ] Deploy Postgres
- [ ] Configurar DNS
- [ ] Verificar health

### Task 10: Documentation
- [ ] API documentation
- [ ] App definition guide
- [ ] Deployment examples
- [ ] Troubleshooting guide

## üì¶ Depend√™ncias Novas

```txt
# requirements.txt
cloudflare>=3.0.0       # SDK oficial Cloudflare (suporta Global API Key)
httpx>=0.25.0          # Cliente HTTP async para Portainer
pyyaml>=6.0            # Parser YAML
jsonschema>=4.0        # Valida√ß√£o de schemas
tenacity>=8.0          # Retry logic
```

## üóÑÔ∏è State Management Simplificado

### Estrutura do state.json (MINIMAL)

```json
{
  "servers": {
    "srv1": {
      "name": "srv1",
      "ip": "168.119.89.45",
      "provider": "hetzner",
      "dns": {
        "zone": "livchat.ai",
        "subdomain": "lab"
      }
    },
    "srv2": {
      "name": "srv2",
      "ip": "192.168.1.100",
      "provider": "hetzner",
      "dns": {
        "zone": "livchat.ai",
        "subdomain": "dev"
      }
    }
  },
  "config": {
    "admin_email": "user@example.com",
    "default_zone": "livchat.ai",
    "cloudflare_email": "cloudflare@example.com"
  }
}
```

**Princ√≠pio:**
- ‚ùå N√ÉO armazenar registros DNS (consultar Cloudflare diretamente)
- ‚ùå N√ÉO armazenar lista de aplica√ß√µes (consultar Portainer diretamente)
- ‚úÖ Armazenar apenas dados essenciais e reutiliz√°veis
- ‚úÖ Zone e subdomain para recriar DNS se necess√°rio

## üéÆ CLI Commands

```bash
# Configurar Cloudflare
livchat-setup configure --cloudflare-email user@example.com --cloudflare-key <global_api_key>

# Deploy de aplica√ß√£o com DNS autom√°tico
livchat-setup deploy-app <server> <app> [--zone livchat.ai] [--subdomain lab]

# Configurar DNS do servidor (cria registro A do Portainer)
livchat-setup setup-dns <server> --zone livchat.ai [--subdomain lab]

# Adicionar DNS para app espec√≠fica (cria CNAME)
livchat-setup add-app-dns <server> <app> [--zone livchat.ai] [--subdomain lab]

# Listar zonas dispon√≠veis no Cloudflare
livchat-setup list-zones

# Status da aplica√ß√£o
livchat-setup app-status <server> <app>
```

## üîÑ Fluxo de Deploy com DNS

1. **Setup inicial do servidor:**
   ```bash
   # Cria servidor
   livchat-setup create-server srv1

   # Setup completo (Docker, Swarm, Traefik)
   livchat-setup setup-server srv1

   # Deploy Portainer + DNS
   livchat-setup deploy-portainer srv1 --zone livchat.ai --subdomain lab
   # Cria automaticamente: ptn.lab.livchat.ai -> IP (registro A)
   ```

2. **Deploy de aplica√ß√µes:**
   ```bash
   # Deploy Chatwoot
   livchat-setup deploy-app srv1 chatwoot
   # Cria automaticamente: chat.lab.livchat.ai -> ptn.lab.livchat.ai (CNAME)

   # Deploy N8N
   livchat-setup deploy-app srv1 n8n
   # Cria automaticamente: edt.lab.livchat.ai -> ptn.lab.livchat.ai (CNAME)
   # Cria tamb√©m: whk.lab.livchat.ai -> ptn.lab.livchat.ai (CNAME para webhook)
   ```

## üéØ Crit√©rios de Sucesso

```bash
# Comandos funcionando:
python -m src.cli deploy-app srv1 portainer
python -m src.cli deploy-app srv1 postgres --config password=secret
python -m src.cli configure-dns srv1 example.com
python -m src.cli list-apps

# Verifica√ß√µes:
curl -I https://portainer.srv1.example.com  # 200 OK
psql -h srv1.example.com -U postgres         # Conecta
dig srv1.example.com                         # Retorna IP correto
```

## üìä M√©tricas

- **Cobertura de testes:** >85%
- **Deploy de app simples:** <2 minutos
- **Deploy com depend√™ncias:** <5 minutos
- **Configura√ß√£o DNS:** <30 segundos
- **Apps catalogadas:** 10+ ao final

## ‚ö†Ô∏è Considera√ß√µes Importantes

1. **Cliente Portainer pr√≥prio** para controle total e sem depend√™ncias externas
2. **SDK Cloudflare oficial** por ser bem mantido e type-safe
3. **Valida√ß√£o rigorosa** de defini√ß√µes YAML antes do deploy
4. **Idempot√™ncia** em todos os deploys
5. **Health checks** obrigat√≥rios p√≥s-deploy

## üöÄ Pr√≥ximos Passos (Plan-04)

1. Deploy N8N com depend√™ncias completas
2. Sistema de backup automatizado
3. Monitoring com Grafana/Prometheus
4. Post-deploy API configurations
5. Multi-server app deployment

## üìä Status

- **Fase:** Planning
- **In√≠cio:** TBD
- **Conclus√£o:** TBD
- **Status:** üîµ READY TO START

---

*Vers√£o: 1.0.0*
*Data Cria√ß√£o: 2025-01-18*
*Status: Planning*
*Abordagem: TDD, Integration-first, Production-ready*