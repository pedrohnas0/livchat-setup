name: n8n
category: automation
version: "1.25.1"
description: Workflow automation platform (SetupOrion pattern)

# Method determines deployment flow
deploy_method: portainer

dependencies:
  - postgres
  - redis  # N8N uses global Redis service

dns_prefix: edt

additional_dns:
  - prefix: whk
    comment: n8n webhook endpoint

# Docker Compose Stack following SetupOrion pattern (3 N8N services)
compose_template: |
  version: '3.8'
  services:
    n8n_editor:
      image: n8nio/n8n:latest
      command: start
      environment:
        - DB_TYPE=postgresdb
        - DB_POSTGRESDB_DATABASE=n8n_queue
        - DB_POSTGRESDB_HOST=postgres
        - DB_POSTGRESDB_PORT=5432
        - DB_POSTGRESDB_USER=postgres
        - DB_POSTGRESDB_PASSWORD={{ vault.postgres_password }}
        - EXECUTIONS_MODE=queue
        - QUEUE_BULL_REDIS_HOST=redis
        - QUEUE_BULL_REDIS_PORT=6379
        - QUEUE_BULL_REDIS_DB=1
        - N8N_ENCRYPTION_KEY={{ encryption_key }}
        - N8N_HOST={{ domain }}
        - N8N_EDITOR_BASE_URL=https://{{ domain }}/
        - WEBHOOK_URL=https://{{ webhook_domain }}/
        - N8N_PROTOCOL=https
        - N8N_PORT=5678
        - TZ=America/Sao_Paulo
      deploy:
        mode: replicated
        replicas: 1
        placement:
          constraints:
            - node.role == manager
        resources:
          limits:
            memory: 2G
          reservations:
            memory: 512M
        labels:
          - "traefik.enable=true"
          - "traefik.http.routers.n8n_editor.rule=Host(`{{ domain }}`)"
          - "traefik.http.routers.n8n_editor.entrypoints=websecure"
          - "traefik.http.routers.n8n_editor.priority=1"
          - "traefik.http.routers.n8n_editor.tls.certresolver=letsencrypt"
          - "traefik.http.routers.n8n_editor.service=n8n_editor"
          - "traefik.http.services.n8n_editor.loadbalancer.server.port=5678"
          - "traefik.http.services.n8n_editor.loadbalancer.passHostHeader=true"
      networks:
        - livchat_network

    n8n_webhook:
      image: n8nio/n8n:latest
      command: webhook
      environment:
        - DB_TYPE=postgresdb
        - DB_POSTGRESDB_DATABASE=n8n_queue
        - DB_POSTGRESDB_HOST=postgres
        - DB_POSTGRESDB_PORT=5432
        - DB_POSTGRESDB_USER=postgres
        - DB_POSTGRESDB_PASSWORD={{ vault.postgres_password }}
        - EXECUTIONS_MODE=queue
        - QUEUE_BULL_REDIS_HOST=redis
        - QUEUE_BULL_REDIS_PORT=6379
        - QUEUE_BULL_REDIS_DB=1
        - N8N_ENCRYPTION_KEY={{ encryption_key }}
        - WEBHOOK_URL=https://{{ webhook_domain }}/
        - N8N_PROTOCOL=https
        - N8N_PORT=5678
        - TZ=America/Sao_Paulo
      deploy:
        mode: replicated
        replicas: 1
        placement:
          constraints:
            - node.role == manager
        resources:
          limits:
            memory: 1G
          reservations:
            memory: 256M
        labels:
          - "traefik.enable=true"
          - "traefik.http.routers.n8n_webhook.rule=(Host(`{{ webhook_domain }}`) && PathPrefix(`/webhook`))"
          - "traefik.http.routers.n8n_webhook.entrypoints=websecure"
          - "traefik.http.routers.n8n_webhook.priority=1"
          - "traefik.http.routers.n8n_webhook.tls.certresolver=letsencrypt"
          - "traefik.http.routers.n8n_webhook.service=n8n_webhook"
          - "traefik.http.services.n8n_webhook.loadbalancer.server.port=5678"
          - "traefik.http.services.n8n_webhook.loadbalancer.passHostHeader=true"
      networks:
        - livchat_network

    n8n_worker:
      image: n8nio/n8n:latest
      command: worker --concurrency=10
      environment:
        - DB_TYPE=postgresdb
        - DB_POSTGRESDB_DATABASE=n8n_queue
        - DB_POSTGRESDB_HOST=postgres
        - DB_POSTGRESDB_PORT=5432
        - DB_POSTGRESDB_USER=postgres
        - DB_POSTGRESDB_PASSWORD={{ vault.postgres_password }}
        - EXECUTIONS_MODE=queue
        - QUEUE_BULL_REDIS_HOST=redis
        - QUEUE_BULL_REDIS_PORT=6379
        - QUEUE_BULL_REDIS_DB=1
        - N8N_ENCRYPTION_KEY={{ encryption_key }}
        - WEBHOOK_URL=https://{{ webhook_domain }}/
        - N8N_PROTOCOL=https
        - TZ=America/Sao_Paulo
      deploy:
        mode: replicated
        replicas: 1
        placement:
          constraints:
            - node.role == manager
        resources:
          limits:
            memory: 2G
          reservations:
            memory: 512M
      networks:
        - livchat_network

  networks:
    livchat_network:
      external: true
      name: livchat_network
